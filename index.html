<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROD-HUB PRO | Production Management</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-color: #ffb400;
            --bg-dark: #080808;
            --card-bg: #141414;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-dim: #94a3b8;
            --danger: #ff4d4d;
            --success: #00e676;
            --ongoing: #33b5e5;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-dark); 
            color: var(--text-main); 
            margin: 0; 
            overflow-x: hidden; 
            padding-bottom: 70px; /* Space for bottom nav */
        }
        .hidden { display: none !important; }

        /* CUSTOM ALERT SYSTEM */
        #custom-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--accent-color); color: #000; padding: 12px 24px;
            border-radius: 50px; font-weight: 800; font-size: 0.8rem; z-index: 9999;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); display: none; animation: slideDown 0.3s ease;
        }

        @keyframes slideDown { from { top: -50px; } to { top: 20px; } }

        /* HEADER & ONLINE COUNTER */
        nav { 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); padding: 12px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000;
        }
        .nav-logo { display: flex; align-items: center; gap: 10px; font-weight: 800; color: var(--accent-color); }
        .nav-logo img { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--accent-color); }

        .online-counter {
            display: flex; align-items: center; gap: 6px; background: rgba(0, 230, 118, 0.1);
            padding: 4px 10px; border-radius: 20px; border: 1px solid var(--success);
        }
        .pulse-dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* TAB NAVIGATION (MOBILE & WEB) */
        .main-tabs {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(20,20,20,0.95); backdrop-filter: blur(15px);
            display: flex; justify-content: space-around; padding: 10px 0;
            border-top: 1px solid var(--border); z-index: 1000;
        }
        .tab-item { 
            display: flex; flex-direction: column; align-items: center; 
            color: var(--text-dim); text-decoration: none; font-size: 0.6rem; font-weight: 700;
        }
        .tab-item.active { color: var(--accent-color); }
        .tab-item i { margin-bottom: 4px; }

        /* SECTION LAYOUTS */
        .content-section { max-width: 800px; margin: 0 auto; padding: 15px; display: none; }
        .content-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* CARDS & ROWS */
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; border: 1px solid var(--border); margin-bottom: 15px; }
        .pitch-row { 
            background: var(--glass); border: 1px solid var(--border); 
            border-radius: 14px; padding: 15px; margin-bottom: 15px; position: relative;
        }
        .priority-high { border-left: 4px solid var(--danger); }
        
        /* FORM STYLES */
        input, textarea, select {
            width: 100%; padding: 14px; margin-bottom: 12px; background: #000;
            border: 1px solid var(--border); color: #fff; border-radius: 10px; font-size: 0.9rem;
        }
        button {
            background: var(--accent-color); color: #000; border: none; padding: 14px;
            border-radius: 10px; font-weight: 800; width: 100%; font-size: 0.8rem; letter-spacing: 1px;
        }

        /* PRODUCTION HUB TABS */
        .hub-sub-tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .sub-tab { 
            white-space: nowrap; padding: 8px 16px; border-radius: 20px; background: #222; 
            font-size: 0.65rem; font-weight: 800; color: #666; cursor: pointer;
        }
        .sub-tab.active { background: var(--accent-color); color: #000; }

        /* GRID TASKS FOR MOBILE */
        .task-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px; }
        .task-btn { 
            background: #000; border: 1px solid #222; padding: 10px; border-radius: 8px;
            font-size: 0.6rem; font-weight: 800; text-align: center;
        }
        .task-btn.done { border-color: var(--success); color: var(--success); }
        .task-btn.ongoing { border-color: var(--ongoing); color: var(--ongoing); }

        .assignment-box { font-size: 0.65rem; color: #777; margin: 10px 0; display: flex; flex-direction: column; gap: 4px; }
    </style>
</head>
<body>

    <div id="custom-toast">Action Successful</div>

    <div id="auth-section" style="height:100vh; display:flex; align-items:center; justify-content:center; background: #000;">
        <div style="width: 90%; max-width: 350px; text-align: center; padding: 30px; background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border);">
            <img src="https://i.imgur.com/7d3ROpd.jpeg" style="width: 70px; border-radius: 50%; border: 2px solid var(--accent-color); margin-bottom: 15px;">
            <h2 style="color: var(--accent-color); letter-spacing: 3px; margin: 0;">PROD-HUB</h2>
            <p style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 25px;">SECURED ACCESS</p>
            <select id="user-role">
                <option value="Producer">Producer</option>
                <option value="Associate Producer">Associate Producer</option>
                <option value="Host">Program Host</option>
                <option value="Editor">Video Editor</option>
                <option value="Writer">Script Writer</option>
                <option value="Camera">Camera/DP</option>
            </select>
            <button onclick="handleGoogleAuth()">CONTINUE WITH GOOGLE</button>
        </div>
    </div>

    <div id="dashboard-section" class="hidden">
        <nav>
            <div class="nav-logo">
                <img src="https://i.imgur.com/7d3ROpd.jpeg"> PROD-HUB
            </div>
            <div class="online-counter">
                <div class="pulse-dot"></div>
                <span style="font-size: 0.55rem; color: var(--success); font-weight: 800;" id="live-online-count">8 CREW ONLINE</span>
            </div>
        </nav>

        <div id="section-hub" class="content-section active">
            <div class="card" style="padding: 15px; display: flex; justify-content: space-around; text-align: center;">
                <div><span class="stat-val" id="total-pitches-count" style="font-size: 1.2rem; font-weight: 800; color: var(--accent-color);">0</span><br><span style="font-size:0.5rem; color:#555">TOTAL</span></div>
                <div><span class="stat-val" id="completed-pitches-count" style="font-size: 1.2rem; font-weight: 800; color: var(--success);">0</span><br><span style="font-size:0.5rem; color:#555">WRAPPED</span></div>
                <div id="clock" style="font-weight: 800; color: #555; font-size: 0.8rem; align-self: center;"></div>
            </div>

            <div class="hub-sub-tabs">
                <div class="sub-tab active" id="tab-approval" onclick="switchHub('approval')">APPROVAL</div>
                <div class="sub-tab" id="tab-production" onclick="switchHub('production')">PRODUCTION</div>
                <div class="sub-tab" id="tab-airing" onclick="switchHub('airing')">AIRING</div>
            </div>

            <input type="text" id="feedSearch" placeholder="Search projects..." onkeyup="filterFeed()" style="margin-bottom: 15px; background: var(--card-bg);">
            <div id="pitch-list">Loading Hub...</div>
        </div>

        <div id="section-create" class="content-section">
            <div class="card">
                <h3 style="margin-bottom: 20px;"><i data-lucide="plus-circle" class="icon-sm"></i> NEW PRODUCTION PITCH</h3>
                <select id="pPriority"><option value="Normal">Normal</option><option value="Urgent">Urgent</option></select>
                <input type="date" id="pDate">
                <input type="text" id="pLoc" placeholder="Location">
                <input type="text" id="pCam" placeholder="Camera/DP Email">
                <input type="text" id="pEditor" placeholder="Editor Email">
                <input type="url" id="pMedia" placeholder="Reference Link">
                <textarea id="pAbout" rows="5" placeholder="Story concept details..."></textarea>
                <button onclick="addPitch()">SUBMIT TO BOARD</button>
            </div>
        </div>

        <div id="section-alerts" class="content-section">
            <div class="card">
                <h3><i data-lucide="megaphone" class="icon-sm"></i> ANNOUNCEMENTS</h3>
                <div id="announcement-board" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="newAnnouncement" placeholder="Write broadcast..." style="margin:0;">
                    <button onclick="postAnnouncement()" style="width: 50px;"><i data-lucide="send" style="width:16px;"></i></button>
                </div>
            </div>
        </div>

        <div id="section-profile" class="content-section">
            <div class="card" style="border-left: 4px solid var(--accent-color);">
                <div id="user-display" style="font-weight: 800; font-size: 1.1rem;">NAME</div>
                <div id="role-tag" style="color: var(--accent-color); font-size: 0.7rem; font-weight: 800; text-transform: uppercase;">ROLE</div>
                <div style="display:flex; gap:8px; margin-top:15px;">
                    <input type="text" id="updateNameInput" placeholder="New display name" style="margin:0;">
                    <button onclick="updateProfileName()" style="width: 80px;">SAVE</button>
                </div>
                <button onclick="handleLogout()" style="background: #222; color: #fff; margin-top: 10px;">LOGOUT SYSTEM</button>
            </div>

            <div class="card">
                <h3><i data-lucide="check-square" class="icon-sm"></i> MY WORKFLOW</h3>
                <div id="task-list"></div>
                <div style="display:flex; gap:8px; margin-top:15px;">
                    <input type="text" id="newTask" placeholder="Add task..." style="margin:0;">
                    <button onclick="addTask()" style="width: 50px;">+</button>
                </div>
            </div>
        </div>

        <div class="main-tabs">
            <a href="javascript:void(0)" class="tab-item active" onclick="showSection('hub', this)"><i data-lucide="layout-grid"></i>HUB</a>
            <a href="javascript:void(0)" class="tab-item" onclick="showSection('create', this)"><i data-lucide="plus-circle"></i>PITCH</a>
            <a href="javascript:void(0)" class="tab-item" onclick="showSection('alerts', this)"><i data-lucide="bell"></i>ALERTS</a>
            <a href="javascript:void(0)" class="tab-item" onclick="showSection('profile', this)"><i data-lucide="user"></i>PROFILE</a>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG (UNCHANGED)
        const firebaseConfig = {
            apiKey: "AIzaSyCWyMPS1vabyK_uGAWzmmeW9iuL7ksEUBE",
            authDomain: "prod-hub-d43c4.firebaseapp.com",
            projectId: "prod-hub-d43c4",
            storageBucket: "prod-hub-d43c4.firebasestorage.app",
            messagingSenderId: "262638128725",
            appId: "1:262638128725:web:12136df5187f89deff8edc"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        let currentHubTab = 'approval';
        let currentUserRole = '';

        // UI NAVIGATION LOGIC
        function showSection(id, el) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById('section-' + id).classList.add('active');
            el.classList.add('active');
            window.scrollTo(0,0);
        }

        function switchHub(tab) {
            currentHubTab = tab;
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            loadGlobalPitches();
        }

        function toast(msg) {
            const t = document.getElementById('custom-toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 3000);
        }

        // MAINTAINED LOGIC FROM ORIGINAL
        auth.onAuthStateChanged(async user => {
            if (user) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');
                const userDoc = await db.collection("users").doc(user.uid).get();
                if(userDoc.exists) {
                    const userData = userDoc.data();
                    currentUserRole = userData.role;
                    document.getElementById('role-tag').innerText = currentUserRole;
                    document.getElementById('user-display').innerText = userData.displayName || user.displayName;
                }
                loadGlobalPitches(); loadPersonalTasks(user.uid); loadAnnouncements(); lucide.createIcons();
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('dashboard-section').classList.add('hidden');
            }
        });

        async function handleGoogleAuth() {
            const role = document.getElementById('user-role').value;
            try {
                const res = await auth.signInWithPopup(provider);
                const user = res.user;
                const doc = await db.collection("users").doc(user.uid).get();
                if (!doc.exists) {
                    await db.collection("users").doc(user.uid).set({
                        role: role, email: user.email, displayName: user.displayName || user.email.split('@')[0]
                    });
                }
            } catch(e) { toast("Error: " + e.message); }
        }

        function handleLogout() { auth.signOut(); }

        // PITCH MANAGEMENT (UNCHANGED LOGIC)
        async function addPitch() {
            const about = document.getElementById('pAbout').value;
            if(!about) return toast("Story details missing");
            await db.collection("pitches").add({
                priority: document.getElementById('pPriority').value,
                date: document.getElementById('pDate').value,
                location: document.getElementById('pLoc').value,
                cameraman: document.getElementById('pCam').value,
                editor: document.getElementById('pEditor').value,
                mediaLink: document.getElementById('pMedia').value,
                about: about, author: auth.currentUser.email,
                approved: false, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                tasks: { script: "", shoot: "", edit: "", vo: "" }
            });
            toast("Pitch Submitted!");
            ['pAbout', 'pLoc', 'pCam', 'pEditor', 'pDate', 'pMedia'].forEach(id => document.getElementById(id).value = '');
            showSection('hub', document.querySelector('.tab-item'));
        }

        function loadGlobalPitches() {
            db.collection("pitches").orderBy("createdAt", "desc").onSnapshot(snapshot => {
                const list = document.getElementById('pitch-list');
                const filtered = snapshot.docs.filter(doc => {
                    const p = doc.data();
                    const isDone = p.tasks?.script === 'done' && p.tasks?.shoot === 'done' && p.tasks?.edit === 'done' && p.tasks?.vo === 'done';
                    if (currentHubTab === 'approval') return !p.approved;
                    if (currentHubTab === 'production') return p.approved && !isDone;
                    if (currentHubTab === 'airing') return p.approved && isDone;
                    return true;
                });

                list.innerHTML = filtered.map(doc => {
                    const p = doc.data();
                    const isOwner = auth.currentUser.email === p.author;
                    const canApprove = ['Producer', 'Associate Producer', 'Host'].includes(currentUserRole);

                    return `
                        <div class="pitch-row ${p.priority === 'Urgent' ? 'priority-high' : ''}">
                            <div style="font-size:0.8rem; font-weight:800; color:var(--accent-color); margin-bottom:10px;">ðŸ“… ${p.date || 'TBD'}</div>
                            <div class="assignment-box">
                                <span><b>LOC:</b> ${p.location}</span>
                                <span><b>CAM:</b> ${p.cameraman || 'TBD'}</span>
                                <span><b>EDITOR:</b> ${p.editor || 'TBD'}</span>
                            </div>
                            <div style="background:rgba(255,255,255,0.03); padding:12px; border-radius:10px; font-size:0.8rem; border:1px solid #222;">
                                ${p.about}
                            </div>
                            
                            ${p.approved ? `
                            <div class="task-grid">
                                <div class="task-btn ${p.tasks?.script || ''}">SCRIPT
                                    <select onchange="handleTaskDropdown('${doc.id}', 'script', this.value, ${isOwner})"><option value="">-</option><option value="ongoing">WIP</option><option value="done">OK</option></select>
                                </div>
                                <div class="task-btn ${p.tasks?.shoot || ''}">SHOOT
                                    <select onchange="handleTaskDropdown('${doc.id}', 'shoot', this.value, true)"><option value="">-</option><option value="ongoing">WIP</option><option value="done">OK</option></select>
                                </div>
                                <div class="task-btn ${p.tasks?.edit || ''}">EDIT
                                    <select onchange="handleTaskDropdown('${doc.id}', 'edit', this.value, true)"><option value="">-</option><option value="ongoing">WIP</option><option value="done">OK</option></select>
                                </div>
                                <div class="task-btn ${p.tasks?.vo || ''}">VO
                                    <select onchange="handleVOActionDropdown('${doc.id}', this.value, true)"><option value="">-</option><option value="ongoing">WIP</option><option value="done">OK</option></select>
                                </div>
                            </div>` : ''}

                            <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-size:0.5rem; opacity:0.5;">BY: ${p.author}</span>
                                <div>
                                    ${!p.approved && canApprove ? `<button onclick="approvePitch('${doc.id}')" style="width:auto; padding:5px 15px; font-size:0.6rem; background:var(--success)">APPROVE</button>` : ''}
                                    ${isOwner ? `<button onclick="deletePitch('${doc.id}')" style="width:auto; padding:5px 15px; font-size:0.6rem; background:var(--danger); margin-left:5px;">DELETE</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') || '<p style="text-align:center; opacity:0.3; padding:20px;">No records found.</p>';
                lucide.createIcons();
            });
        }

        async function handleTaskDropdown(id, type, val, hasPermit) {
            if(!hasPermit) return toast("Unauthorized");
            const update = {}; update[`tasks.${type}`] = val;
            await db.collection("pitches").doc(id).update(update);
            toast("Status Updated");
        }

        async function handleVOActionDropdown(id, val, hasPermit) {
            if(!hasPermit) return toast("Host/AP Only");
            await db.collection("pitches").doc(id).update({"tasks.vo": val});
            toast("VO Updated");
        }

        async function approvePitch(id) {
            if(confirm("Approve for Production?")) {
                await db.collection("pitches").doc(id).update({ approved: true });
                toast("Moved to Production");
            }
        }

        async function deletePitch(id) {
            if(confirm("Confirm Delete?")) {
                await db.collection("pitches").doc(id).delete();
                toast("Pitch Deleted");
            }
        }

        // ANNOUNCEMENTS & TASKS
        function loadAnnouncements() {
            db.collection("announcements").orderBy("createdAt", "desc").limit(10).onSnapshot(snap => {
                document.getElementById('announcement-board').innerHTML = snap.docs.map(doc => `
                    <div style="border-bottom:1px solid #1a1a1a; padding:10px 0;">
                        <span style="color:var(--accent-color); font-weight:800; font-size:0.6rem;">${doc.data().author}</span>
                        <div style="font-size:0.8rem;">${doc.data().text}</div>
                    </div>
                `).join('');
            });
        }

        async function postAnnouncement() {
            const txt = document.getElementById('newAnnouncement').value;
            if(!txt) return;
            await db.collection("announcements").add({
                text: txt, author: auth.currentUser.displayName || auth.currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('newAnnouncement').value = '';
        }

        function loadPersonalTasks(uid) {
            db.collection("tasks").where("uid", "==", uid).onSnapshot(snap => {
                document.getElementById('task-list').innerHTML = snap.docs.map(doc => `
                    <div style="display:flex; align-items:center; justify-content:space-between; background:#000; padding:12px; border-radius:10px; margin-bottom:8px; border:1px solid #1a1a1a;">
                        <span style="font-size:0.8rem; ${doc.data().done ? 'text-decoration:line-through; opacity:0.3' : ''}">${doc.data().text}</span>
                        <input type="checkbox" ${doc.data().done ? 'checked' : ''} onchange="toggleTask('${doc.id}', ${doc.data().done})" style="width:auto; margin:0;">
                    </div>
                `).join('');
            });
        }

        async function addTask() {
            const val = document.getElementById('newTask').value;
            if(!val) return;
            await db.collection("tasks").add({ uid: auth.currentUser.uid, text: val, done: false, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById('newTask').value = '';
        }

        async function toggleTask(id, status) { await db.collection("tasks").doc(id).update({ done: !status }); }

        function filterFeed() {
            const q = document.getElementById('feedSearch').value.toLowerCase();
            document.querySelectorAll('.pitch-row').forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(q) ? 'block' : 'none';
            });
        }

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
            // Static simulation of online count for UI feel
            document.getElementById('live-online-count').innerText = (Math.floor(Math.random() * 5) + 7) + " CREW ONLINE";
        }, 1000);

        async function updateProfileName() {
            const n = document.getElementById('updateNameInput').value;
            if(!n) return;
            await db.collection("users").doc(auth.currentUser.uid).update({ displayName: n });
            toast("Name Updated!");
        }
    </script>
</body>
</html>
